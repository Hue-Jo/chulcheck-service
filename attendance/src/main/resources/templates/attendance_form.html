<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì¶œì„ ì²´í¬</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 30px;
      background: #fafafa;
      color: #333;
    }

    h1 {
      margin-bottom: 20px;
      font-weight: 700;
      color: #2c3e50;
      text-align: center;
    }

    .title-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .add-btn {
      background-color: #f2900b;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    input[type="radio"] {
      display: none;
    }

    .section-divider {
      border-top: 1px solid #ccc;
      margin: 24px 0 12px;
    }

    .student-card-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .student-card {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      max-width: 100%;
      box-sizing: border-box;
    }

    .student-name {
      font-weight: bold;
      font-size: 1.2rem;
      color: #2c3e50;
      flex: 1 1 auto;
      min-width: 100px;
      white-space: nowrap;
      margin-left: 10px;
    }

    .attendance-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
      margin-left: 16px;
    }

    .attendance-buttons label {
      padding: 6px 10px;
      border-radius: 8px;
      border: 2px solid #ccc;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: border-color 0.3s, color 0.3s;
      user-select: none;
      display: inline-block;
      text-align: center;
      min-width: 50px;
      background-color: transparent;
    }

    .attendance-buttons input[type="radio"]:checked + label.present-label {
      background-color: #e8f5e9;
      color: #1b4d1b !important;
      border-color: #4caf50 !important;
      font-weight: 700;
    }

    .attendance-buttons input[type="radio"]:checked + label.absent-label {
      background-color: #ffebee;
      color: #7f2a2a !important;
      border-color: #f44336 !important;
      font-weight: 700;
    }

    .attendance-buttons input[type="radio"]:checked + label.present-label {
      color: #1b4d1b !important;
      border-color: #4caf50 !important;
      font-weight: 700;
    }

    .attendance-buttons input[type="radio"]:checked + label.absent-label {
      color: #7f2a2a !important;
      border-color: #f44336 !important;
      font-weight: 700;
    }

    .reason-section {
      display: none;
      flex-basis: 100%;
      margin-top: 8px;
      flex-direction: column;
      gap: 6px;
    }

    .reason-section select,
    .reason-section input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    button[type="submit"] {
      display: block;
      margin: 30px auto 0;
      padding: 12px 28px;
      font-weight: 700;
      font-size: 1.1rem;
      background-color: #3f51b5;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(63, 81, 181, 0.4);
      transition: background-color 0.3s ease;
    }

    @media (max-width: 480px) {
      .student-card {
        padding: 12px 12px;
      }

      .student-name {
        font-size: 1.1rem;
        min-width: 80px;
      }

      .attendance-buttons label {
        min-width: 46px;
        padding: 6px 8px;
        font-size: 1rem;
      }
    }

    #studentModal {
      display: none;
      position: fixed;
      z-index: 999;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      position: relative;
      background: white;
      padding: 20px 30px 40px;
      border-radius: 8px;
      width: 300px;
    }

    .modal-content input[type="text"] {
      width: 92%;
      padding: 10px;
      margin-bottom: 10px;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      background: transparent;
      border: none;
      font-size: 30px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }

    .modal-buttons {
      text-align: center;
      margin-top: 10px;
    }

    .modal-buttons .submit-btn {
      background-color: #3f51b5;
      color: white;
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
    }

    /* í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    #toast {
      visibility: hidden;
      min-width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 12px;
      padding: 16px 24px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%);
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      transition: opacity 0.5s ease, visibility 0.5s;
      opacity: 0;
    }

  </style>
</head>
<body>

<div class="title-bar">
  <h1>ğŸ“‹ ì¶œì„ ì²´í¬</h1>
  <button class="add-btn" type="button" onclick="openStudentModal()">â• ìƒˆ ì¹œêµ¬</button>
</div>

<div style="margin-bottom: 10px;">
  <p><strong>ë‹´ë‹¹ ì…€ :</strong> <span th:text="${formDto.cell.name}"></span></p>
  <p><strong>ë‹´ë‹¹ êµì‚¬:</strong> <span th:text="${formDto.cell.teacher}"></span></p>
  <p><strong>ì¶œì„ ë‚ ì§œ:</strong> <span th:text="${#temporals.format(formDto.today, 'yyyy-MM-dd')}"></span></p>
</div>

<div class="section-divider"></div>

<form th:action="@{/attendance/submit}" method="post">
  <input type="hidden" name="cellId" th:value="${formDto.cell.id}"/>
  <input type="hidden" name="date" th:value="${#temporals.format(formDto.today, 'yyyy-MM-dd')}"/>

  <div class="student-card-container">
    <div class="student-card" th:each="student : ${formDto.students}">
      <div class="student-name" th:text="${student.name}">í•™ìƒ ì´ë¦„</div>

      <div class="attendance-buttons">
        <input
            type="radio"
            th:id="'present_' + ${student.id}"
            th:name="'status_' + ${student.id}"
            th:value="'PRESENT'"
            class="present"
            th:checked="${formDto.attendanceMap == null or formDto.attendanceMap[student.id] == null or formDto.attendanceMap[student.id]?.status?.name() == 'PRESENT'}"
            th:onclick="'toggleReasonInput(' + ${student.id} + ')'"
        />
        <label th:for="'present_' + ${student.id}" class="present-label">ì¶œì„</label>

        <input
            type="radio"
            th:id="'absent_' + ${student.id}"
            th:name="'status_' + ${student.id}"
            th:value="'ABSENT'"
            class="absent"
            th:checked="${formDto.attendanceMap != null and formDto.attendanceMap[student.id]?.status?.name() == 'ABSENT'}"
            th:onclick="'toggleReasonInput(' + ${student.id} + ')'"
        />
        <label th:for="'absent_' + ${student.id}" class="absent-label">ê²°ì„</label>
      </div>

      <div class="reason-section" th:id="'reasonSection_' + ${student.id}">
        <select
            th:name="'absenceReason_' + ${student.id}"
            th:id="'reasonSelect_' + ${student.id}"
            th:onchange="'toggleCustomReason(' + ${student.id} + ')'"
            required
        >
          <option value="" disabled selected>ì„ íƒ</option>
          <option
              th:each="reason : ${formDto.absenceReasons}"
              th:value="${reason.name()}"
              th:selected="${formDto.attendanceMap[student.id]?.absenceReason?.name() == reason.name()}"
              th:text="${reason.displayName}"
          >
            ì‚¬ìœ 
          </option>
        </select>

        <input
            type="text"
            th:name="'customReason_' + ${student.id}"
            th:id="'customReason_' + ${student.id}"
            th:value="${formDto.attendanceMap[student.id]?.customReason}"
            placeholder="ê¸°íƒ€ ì‚¬ìœ  ì…ë ¥"
            style="display:none;"
        />
      </div>
    </div>
  </div>

  <button type="submit">ì¶œê²°ì‚¬í•­ ì œì¶œ</button>

</form>
<div id="studentModal" style="display:none;">
  <div class="modal-content">
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ X ë²„íŠ¼ -->
    <button class="close-btn" onclick="closeStudentModal()" aria-label="ë‹«ê¸°">&times;</button>

    <h2 style="margin-top: 0;">ìƒˆ ì¹œêµ¬ ë“±ë¡</h2>
    <form id="addStudentForm">
      <input type="hidden" name="cellId" th:value="${formDto.cell.id}"/>
      <input type="text" name="studentName" placeholder="ì´ë¦„" required
             style="margin-top: 10px; margin-bottom: 2px;"/>
      <div class="modal-buttons">
        <button type="submit" class="submit-btn">ë“±ë¡</button>
        <p>âš ï¸ ìƒˆ ì¹œêµ¬ë¥¼ ë“±ë¡í•˜ë©´ í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ë˜ì–´<br/>ê¸°ì¡´ì— ì²´í¬í–ˆë˜ ì¶œê²°ì‚¬í•­ì´<br/>ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </form>
  </div>
</div>
<div id="toast" style="
  visibility: hidden;
  min-width: 200px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 12px;
  padding: 16px 24px;
  position: fixed;
  z-index: 9999;
  left: 50%;
  bottom: 80px;
  transform: translateX(-50%);
  font-size: 1.1rem;
  font-weight: bold;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  transition: opacity 0.5s ease, visibility 0.5s;
  opacity: 0;
"></div>

</body>
<script>
  function toggleReasonInput(studentId) {
    const presentRadio = document.querySelector(
        `input[name='status_${studentId}'][value='PRESENT']`
    );
    const reasonSection = document.querySelector(`#reasonSection_${studentId}`);

    if (presentRadio.checked) {
      reasonSection.style.display = 'none';
      const select = reasonSection.querySelector('select');
      const customInput = reasonSection.querySelector('input[type="text"]');
      select.value = '';
      select.required = false;
      customInput.style.display = 'none';
      customInput.value = '';
    } else {
      reasonSection.style.display = 'flex';
      const select = reasonSection.querySelector('select');
      const customInput = reasonSection.querySelector('input[type="text"]');
      select.required = true;
      toggleCustomReason(studentId);
    }
  }

  function toggleCustomReason(studentId) {
    const select = document.getElementById(`reasonSelect_${studentId}`);
    const customInput = document.getElementById(`customReason_${studentId}`);

    if (select.value === 'OTHER') {
      customInput.style.display = 'block';
    } else {
      customInput.style.display = 'none';
      customInput.value = '';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ìƒíƒœì— ë”°ë¼ ì‚¬ìœ  ì…ë ¥ì°½ í† ê¸€
    document.querySelectorAll('.student-card').forEach(card => {
      const studentId = card.querySelector("input[type='radio']").name.replace('status_', '');
      toggleReasonInput(studentId);
    });

    // í…ìŠ¤íŠ¸ ì…ë ¥ë€ì—ì„œ Enterí‚¤ ìë™ ì œì¶œ ë°©ì§€, í‚¤ë³´ë“œ ë°‘ìœ¼ë¡œ ë‚´ë ¤ê°€ê²Œ ì„¤ì •
    document.querySelectorAll("input[type='text']").forEach(input => {
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          input.blur();
        }
      });
    });

    // ìƒˆ ì¹œêµ¬ ë“±ë¡ í¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    const addStudentForm = document.getElementById("addStudentForm");
    if (addStudentForm) {
      addStudentForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(addStudentForm);

        fetch('/students/add', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast("âœ… ìƒˆ ì¹œêµ¬ ë“±ë¡ ì™„ë£Œ!");
            setTimeout(() => location.reload(), 1000); // í† ìŠ¤íŠ¸ ë³´ì´ê³  1ì´ˆ í›„ ìƒˆë¡œê³ ì¹¨
          } else {
            showToast("âŒ ë“±ë¡ ì‹¤íŒ¨: " + data.message);
          }
          closeStudentModal();
        })
        .catch(err => {
          showToast("âš ï¸ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
          closeStudentModal();
        });
      });

      // ìƒˆ ì¹œêµ¬ ì´ë¦„ ì…ë ¥ì°½ì—ì„œ Enterí‚¤ ëˆŒëŸ¬ë„ í¼ ì œì¶œ ì•ˆë˜ë„ë¡ ë°©ì§€
      const nameInput = addStudentForm.querySelector("input[name='studentName']");
      if (nameInput) {
        nameInput.addEventListener('keydown', function (event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            nameInput.blur(); // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ë‚´ë ¤ê°€ê²Œ ì²˜ë¦¬
          }
        });
      }
    }
  });

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.style.visibility = "visible";
    toast.style.opacity = "1";

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.visibility = "hidden";
    }, 1000); // 1ì´ˆ í›„ í† ìŠ¤íŠ¸ ì‚¬ë¼ì§
  }

  // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
  function openStudentModal() {
    document.getElementById("studentModal").style.display = "flex";
  }

  // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
  function closeStudentModal() {
    document.getElementById("studentModal").style.display = "none";
  }
</script>


</html>